# Consultations API è¨­è¨ˆæ›¸

## 1. ãƒ¡ã‚¿æƒ…å ±

- **å¯¾è±¡ãƒ‰ãƒ¡ã‚¤ãƒ³**: Consultations
- **å…±é€šãƒ‡ãƒ¼ã‚¿å½¢å¼**: JSON (UTF-8)
- **æ›´æ–°æ—¥**: 2026-01-01
- **æ›´æ–°å†…å®¹**: åˆç‰ˆä½œæˆ

## 2. å€‹åˆ¥APIå®šç¾©

### ğŸ“ create-consultation: ç›¸è«‡ã®ä½œæˆ

#### POST /api/consultations

ç›¸è«‡ã‚’æ–°è¦ä½œæˆã—ã¾ã™ã€‚ä¸‹æ›¸ãä¿å­˜ã¨å…¬é–‹ã®ä¸¡æ–¹ã«å¯¾å¿œã—ã¾ã™ã€‚

- **èªè¨¼:** âœ… å¿…é ˆï¼ˆauthGuardãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼‰
- **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³:** æœªå®Ÿè£…
- **ã‚¿ã‚°:** consultations, create

#### ãƒ‘ã‚¹/ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (Parameters)

ãªã—

#### ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ (Request Body)

```text
# ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å: å‹ (å¿…é ˆ/ä»»æ„) # èª¬æ˜
title: string (å¿…é ˆ) # ç›¸è«‡ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ1ã€œ100æ–‡å­—ï¼‰
body: string (å¿…é ˆ) # ç›¸è«‡æœ¬æ–‡ï¼ˆ10ã€œ10,000æ–‡å­—ï¼‰
draft: boolean (ä»»æ„) # ä¸‹æ›¸ãçŠ¶æ…‹ãƒ•ãƒ©ã‚°ã€‚true: ä¸‹æ›¸ãã€false: å…¬é–‹ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: false
```

**Request Example (JSON):**

```json
{
  "title": "ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®ã‚­ãƒ£ãƒªã‚¢ãƒ‘ã‚¹ã«ã¤ã„ã¦",
  "body": "é–‹ç™ºã¨ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã€ã©ã¡ã‚‰ã®é“ã‚’é¸ã¶ã¹ãã‹æ‚©ã‚“ã§ã„ã¾ã™ã€‚ãã‚Œãã‚Œã®ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
  "draft": false
}
```

**ä¸‹æ›¸ãä¿å­˜ã®ä¾‹:**

```json
{
  "title": "AWSç’°å¢ƒæ§‹ç¯‰ã«ã¤ã„ã¦",
  "body": "ã¾ã æ›¸ãã‹ã‘ã®å†…å®¹ã§ã™...",
  "draft": true
}
```

**ã‚µãƒ¼ãƒãƒ¼å´ã§è‡ªå‹•ç”Ÿæˆãƒ»è¨­å®šã•ã‚Œã‚‹é …ç›®:**
- `id`: è‡ªå‹•æ¡ç•ª
- `authorId`: èªè¨¼æƒ…å ±ï¼ˆ`c.get('appUserId')`ï¼‰ã‹ã‚‰è‡ªå‹•å–å¾—
- `created_at` / `updated_at`: DBå´ã§è‡ªå‹•ç”Ÿæˆ
- `hidden_at`: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ`null`ï¼ˆãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒéè¡¨ç¤ºã«ã™ã‚‹ãŸã‚ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€ä½œæˆæ™‚ã¯å¸¸ã«nullï¼‰
- `solved_at`: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ`null`ï¼ˆè§£æ±ºæ™‚ã«è¨­å®šã•ã‚Œã‚‹ï¼‰

#### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (Responses)

##### ğŸŸ¢ 201 Created

ç›¸è«‡ã®ä½œæˆã«æˆåŠŸã—ã¾ã—ãŸã€‚

```text
# ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å: å‹ # èª¬æ˜
id: integer # ä½œæˆã•ã‚ŒãŸç›¸è«‡ã®ID
title: string # ç›¸è«‡ã‚¿ã‚¤ãƒˆãƒ«
body_preview: string # æœ¬æ–‡ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€åˆã®100æ–‡å­—ï¼‰
draft: boolean # ä¸‹æ›¸ãçŠ¶æ…‹ãƒ•ãƒ©ã‚°
hidden_at: datetime|null # éå…¬é–‹æ—¥æ™‚ï¼ˆå¸¸ã«nullï¼‰
solved_at: datetime|null # è§£æ±ºæ—¥æ™‚ï¼ˆå¸¸ã«nullï¼‰
created_at: string # ä½œæˆæ—¥æ™‚ (ISO 8601)
updated_at: string # æœ€çµ‚æ›´æ–°æ—¥æ™‚ (ISO 8601)
author: ref # Authorã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆä½œæˆè€…æƒ…å ±ï¼‰
```

**Response Example (JSON):**

```json
{
  "id": 105,
  "title": "ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®ã‚­ãƒ£ãƒªã‚¢ãƒ‘ã‚¹ã«ã¤ã„ã¦",
  "body_preview": "é–‹ç™ºã¨ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã€ã©ã¡ã‚‰ã®é“ã‚’é¸ã¶ã¹ãã‹æ‚©ã‚“ã§ã„ã¾ã™ã€‚ãã‚Œãã‚Œã®ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
  "draft": false,
  "hidden_at": null,
  "solved_at": null,
  "created_at": "2026-01-01T10:00:00Z",
  "updated_at": "2026-01-01T10:00:00Z",
  "author": {
    "id": 12,
    "name": "taro yamada",
    "disabled": false
  }
}
```

##### ğŸ”´ 400 Bad Request

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã€‚

**ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«:**
- `title`: 1ã€œ100æ–‡å­—ï¼ˆå¿…é ˆï¼‰
- `body`: 10ã€œ10,000æ–‡å­—ï¼ˆå¿…é ˆï¼‰
- `draft`: booleanå‹ï¼ˆä»»æ„ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: falseï¼‰

**æƒ³å®šã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹:**
- `title`ãŒç©ºæ–‡å­—ã¾ãŸã¯æœªæŒ‡å®š
- `title`ãŒ100æ–‡å­—ã‚’è¶…é
- `body`ãŒ10æ–‡å­—æœªæº€ã¾ãŸã¯æœªæŒ‡å®š
- `body`ãŒ10,000æ–‡å­—ã‚’è¶…é
- `draft`ãŒbooleanä»¥å¤–ã®å€¤


##### ğŸ”´ 401 Unauthorized

èªè¨¼ã‚¨ãƒ©ãƒ¼ã€‚æœ‰åŠ¹ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã€‚

```json
{
  "error": "Unauthorized. Session invalid or missing."
}
```

##### ğŸ”´ 500 Internal Server Error

ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã€‚

```json
{
  "error": "Internal server error",
  "message": "Failed to create consultation"
}
```

---

## 3. å®Ÿè£…è©³ç´°

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
Controller (consultations.controller.ts)
  â†“ ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  â†“ èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾— (c.get('appUserId'))
Service (consultation.service.ts)
  â†“ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ (body_previewç”Ÿæˆãªã©)
Repository (consultation.repository.ts)
  â†“ DB INSERT
DB (D1 Database)
```

### ä¸»è¦ãªå®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ

#### 1. èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å–å¾—

```typescript
// Controllerå±¤
const authorId = c.get('appUserId');  // authGuardãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒè¨­å®š
```

`authGuard`ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒèªè¨¼æƒ…å ±ã‹ã‚‰æ¥­å‹™ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆ`appUserId`ï¼‰ã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«è‡ªå‹•è¨­å®šã—ã¾ã™ã€‚

#### 2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆzodã§å®Ÿè£…äºˆå®šï¼‰

```typescript
// validators/consultation.validator.ts (äºˆå®š)
export const createConsultationSchema = z.object({
  title: z.string().min(1).max(100),
  body: z.string().min(10).max(10000),
  draft: z.boolean().optional().default(false),
});
```

**ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»•æ§˜:**
- `title`: 1ã€œ100æ–‡å­—ï¼ˆç©ºæ–‡å­—ä¸å¯ï¼‰
- `body`: 10ã€œ10,000æ–‡å­—ï¼ˆæœ€ä½10æ–‡å­—ã¯å¿…è¦ï¼‰
- `draft`: booleanå‹ã€çœç•¥æ™‚ã¯`false`ï¼ˆå…¬é–‹çŠ¶æ…‹ï¼‰

#### 3. Repositoryå±¤ã§ã®INSERT

```typescript
// Repositoryå±¤ (äºˆå®š)
async create(data: { title, body, draft, authorId }) {
  return await this.db.insert(consultations).values({
    title: data.title,
    body: data.body,
    draft: data.draft,
    authorId: data.authorId,
    // created_at, updated_at ã¯ DBå´ã§è‡ªå‹•ç”Ÿæˆ
    // hidden_at, solved_at ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§null
  }).returning();
}
```

#### 4. Serviceå±¤ã§ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢

```typescript
// Serviceå±¤ (äºˆå®š)
async createConsultation(data, authorId) {
  const created = await this.repository.create({ ...data, authorId });
  
  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã«æ•´å½¢ (body_previewç”Ÿæˆãªã©)
  return {
    id: created.id,
    title: created.title,
    body_preview: created.body.substring(0, 100),
    draft: created.draft,
    // ...
  };
}
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

1. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ** â†’ `{ title, body, draft }` ã‚’é€ä¿¡
2. **Controller** â†’ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ & `authorId`å–å¾—
3. **Service** â†’ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ
4. **Repository** â†’ DB INSERT
5. **Service** â†’ `body_preview`ç”Ÿæˆ & ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢
6. **Controller** â†’ 201 Createdè¿”å´

---

## 4. æ±ºå®šäº‹é …

### âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶é™å€¤

**title ã®æ–‡å­—æ•°åˆ¶é™:**
- æœ€å°æ–‡å­—æ•°: 1æ–‡å­—
- æœ€å¤§æ–‡å­—æ•°: 100æ–‡å­—

**body ã®æ–‡å­—æ•°åˆ¶é™:**
- æœ€å°æ–‡å­—æ•°: 10æ–‡å­—ï¼ˆç°¡æ½”ã™ãã‚‹ç›¸è«‡ã‚’é˜²ãï¼‰
- æœ€å¤§æ–‡å­—æ•°: 10,000æ–‡å­—ï¼ˆã‚³ãƒ¼ãƒ‰ä¾‹ã‚’å«ã‚€æŠ€è¡“ç›¸è«‡ã«ã‚‚å¯¾å¿œå¯èƒ½ï¼‰

**æŠ€è¡“çš„èƒŒæ™¯:**
- SQLite TEXTå‹ã®åˆ¶é™: ç´„1GBï¼ˆå®Ÿè³ªçš„ã«ç„¡åˆ¶é™ï¼‰
- Cloudflare D1/Workers: ãƒ¡ãƒ¢ãƒªåˆ¶é™128MBï¼ˆ10,000æ–‡å­—â‰ˆ30KBã¯ä½™è£•ï¼‰
- å®Ÿç”¨ä¸Šã®å¦¥å½“æ€§: Stack Overflowã¯30,000æ–‡å­—ã€Qiitaã¯åˆ¶é™ãªã—

### âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¨­è¨ˆ

**ä½œæˆã—ãŸç›¸è«‡ã®å…¨æƒ…å ±ã‚’è¿”ã™ä»•æ§˜**

ä½œæˆæˆåŠŸæ™‚ï¼ˆ201 Createdï¼‰ã¯ã€ä½œæˆã—ãŸç›¸è«‡ã®å®Œå…¨ãªConsultationã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã—ã¾ã™ã€‚

**æ¡ç”¨ç†ç”±:**
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒä½œæˆå¾Œã™ãã«ç”»é¢è¡¨ç¤ºã§ãã‚‹ï¼ˆè¿½åŠ ã®APIå‘¼ã³å‡ºã—ä¸è¦ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Šï¼ˆä½œæˆâ†’å³åº§ã«å†…å®¹ç¢ºèªï¼‰
- list APIã¨åŒã˜å½¢å¼ã§çµ±ä¸€æ€§ãŒã‚ã‚‹

### âœ… draftã¨hidden_atã®ä»•æ§˜

**draftï¼ˆä¸‹æ›¸ããƒ•ãƒ©ã‚°ï¼‰:**
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `false`ï¼ˆå…¬é–‹çŠ¶æ…‹ï¼‰
- ç›¸è«‡ä½œæˆæ™‚ã«`draft: true`ã‚’æŒ‡å®šã™ã‚‹ã¨ä¸‹æ›¸ãä¿å­˜
- æŠ•ç¨¿è€…è‡ªèº«ã®ã¿ãŒé–²è¦§å¯èƒ½ãªçŠ¶æ…‹

**hidden_atï¼ˆéè¡¨ç¤ºæ—¥æ™‚ï¼‰:**
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `null`ï¼ˆè¡¨ç¤ºçŠ¶æ…‹ï¼‰
- **ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒéè¡¨ç¤ºã«ã™ã‚‹ãŸã‚ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**ï¼ˆæ²»å®‰ç¶­æŒç›®çš„ï¼‰
- ç›¸è«‡ä½œæˆAPIã§ã¯å¸¸ã«`null`ã§ä½œæˆã•ã‚Œã‚‹
- å¾Œã‹ã‚‰åˆ¥ã®APIï¼ˆãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰ã§è¨­å®šã•ã‚Œã‚‹æƒ³å®š
- `null`è¨±å®¹å‹ï¼ˆnullableï¼‰

**ä½¿ã„åˆ†ã‘:**
- `draft=true`: æŠ•ç¨¿è€…ã«ã‚ˆã‚‹ä¸‹æ›¸ãä¿å­˜ï¼ˆæœªå…¬é–‹ï¼‰
- `draft=false` + `hidden_at=null`: é€šå¸¸ã®å…¬é–‹çŠ¶æ…‹
- `draft=false` + `hidden_at!=null`: ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ã«ã‚ˆã‚Šéè¡¨ç¤ºã«ã•ã‚ŒãŸçŠ¶æ…‹

---

## 5. ä»Šå¾Œã®å®Ÿè£…äºˆå®š

### ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼ˆå°†æ¥å®Ÿè£…ï¼‰

**hidden_at ã®æ›´æ–°API:**
- ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒä¸é©åˆ‡ãªç›¸è«‡ã‚’éè¡¨ç¤ºã«ã™ã‚‹æ©Ÿèƒ½
- `PATCH /api/consultations/:id/hide` ãªã©ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- `hidden_at`ã«ç¾åœ¨æ—¥æ™‚ã‚’è¨­å®š

-----

