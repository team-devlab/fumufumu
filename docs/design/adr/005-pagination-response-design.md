# [ADR] ページネーションのレスポンス設計とデフォルト件数の決定

* **Status**: Accepted
* **Date**: 2026-02-07
* **Context**:
  * 相談一覧API（`GET /api/consultations`）にページネーション機能を追加するにあたり、以下の設計判断が必要となった：
    1. レスポンスに含めるページネーション情報の粒度（最小限 vs 充実）
    2. デフォルトの1ページあたりの件数（limit）
  * フロントエンド（React）、将来的なモバイルアプリ、管理画面など、複数のクライアントからの利用を想定する必要がある。
  * パフォーマンス、ユーザビリティ、保守性のバランスを考慮した決定が求められる。

---

## Decision 1: レスポンス型の選択

### 採用: メタデータ充実型

```typescript
type ConsultationListResponse = {
  data: Consultation[];
  pagination: {
    current_page: number;     // 現在のページ番号
    per_page: number;         // 1ページあたりの件数
    total_items: number;      // 全体の件数
    total_pages: number;      // 全体のページ数
    has_next: boolean;        // 次ページの有無
    has_prev: boolean;        // 前ページの有無
  };
};
```

### 不採用: シンプル型

```typescript
type ConsultationListResponse = {
  data: Consultation[];
  meta: {
    total: number;
    page: number;
    limit: number;
  };
};
```

---

## Comparison of Approaches

| 観点 | メタデータ充実型 | シンプル型 |
|------|----------------|-----------|
| **情報量** | 6項目 | 3項目 |
| **レスポンスサイズ** | 約120バイト | 約50バイト |
| **フロントでの計算** | 不要 | 必要 |
| **実装速度** | ◎ 速い | △ 計算ロジック実装が必要 |
| **保守性** | ◎ 高い（ロジック一元化） | △ 各クライアントで実装必要 |
| **バグ混入リスク** | ◎ 低い | △ 計算ミスの可能性あり |
| **DRY原則** | ◎ 遵守（1箇所で計算） | ✖ 違反（各所で同じ計算） |

---

## Consequences: Decision 1（レスポンス型）

### Merit

1. **フロントエンド実装の簡素化**
   ```tsx
   // 計算不要、即座に使える
   <button disabled={!pagination.has_next}>次へ</button>
   <span>{pagination.current_page} / {pagination.total_pages}</span>
   ```

2. **計算ロジックの一元化（DRY原則）**
   - バックエンドで1回計算 → 全クライアントで利用可能
   - React、モバイルアプリ、管理画面で同じロジックを実装する必要がない

3. **バグ混入リスクの低減**
   - フロント側で `Math.ceil(total / limit)` の計算ミスがない
   - 境界値（101件 ÷ 20件 = 6ページ）の判定ミスを防止

4. **可読性の向上**
   ```typescript
   if (pagination.has_next) {
     // 次ページがある
   }
   // ↑ 意味が一目瞭然
   ```

5. **テストの簡素化**
   - フロント側でページネーション計算のテストが不要
   - バックエンドで一元的にテスト

### Demerit

1. **レスポンスサイズの微増**
   - 約70バイトの増加（全体の0.7%程度）
   - 実際の影響は無視できるレベル

2. **バックエンドの計算コスト**
   - `total_pages`, `has_next`, `has_prev` の計算が必要
   - ただし、計算量は O(1) で実質的なコストは無視できる

---

## Decision 2: デフォルト件数

### 採用: 20件

```typescript
const DEFAULT_LIMIT = 20;
const MIN_LIMIT = 1;
const MAX_LIMIT = 100;
```

---

## 根拠: Decision 2（デフォルト件数）

### 1. 業界標準との整合性

| サービス | デフォルト件数 | 対象 |
|---------|--------------|------|
| GitHub | 30件 | Issue一覧 |
| Twitter/X | 20件 | タイムライン |
| Reddit | 25件 | スレッド一覧 |
| Stack Overflow | 15件 | 質問一覧 |
| Qiita | 20件 | 記事一覧 |

**平均: 約20件** → 業界デファクトスタンダード

### 2. パフォーマンス最適化

```
想定データサイズ（1件あたり）:
- タイトル: 60文字 = 約120バイト
- 本文プレビュー: 100文字 = 約200バイト
- 著者情報: 約100バイト
- その他メタデータ: 約80バイト
合計: 約500バイト/件

レスポンスサイズ:
- 10件: 5KB   ← 少なすぎ（頻繁なページ遷移）
- 20件: 10KB  ← ✅ 最適（4G回線で約0.3秒）
- 50件: 25KB  ← 初回ロードが重い
- 100件: 50KB ← モバイルで遅延発生
```

### 3. ユーザビリティ

```
画面表示:
- デスクトップ: 1画面に3-4件表示
- モバイル: 1画面に2-3件表示

20件の場合のスクロール回数:
- デスクトップ: 約5回スクロール
- モバイル: 約7回スクロール

→ 適度な探索 + 次ページへの期待感を維持
```

**10件の場合:**
- ページ遷移が頻繁すぎる
- ユーザーがストレスを感じる

**50件以上の場合:**
- スクロール疲れ
- 「情報が多すぎる」と感じる
- 初回ロードが遅い

### 4. データベース負荷

```sql
-- 20件の場合（最適）
SELECT * FROM consultations 
ORDER BY created_at DESC 
LIMIT 20 OFFSET 0;
-- 実行時間: 約5ms

-- 100件の場合（重い）
SELECT * FROM consultations 
ORDER BY created_at DESC 
LIMIT 100 OFFSET 0;
-- 実行時間: 約15ms

-- JOINが入ると差はさらに大きくなる
```

### 5. 心理的最適化

```
20件 = 1画面（3-4件）× 約5回スクロール

→ ユーザーの満足感:
  ✓ 十分な情報量がある（選択肢が豊富）
  ✓ でも、圧倒されない（疲れない）
  ✓ 次ページへの期待が残る（探索意欲の維持）
```

---

## Consequences: Decision 2（デフォルト件数）

### Merit

1. **最適なレスポンス時間**
   - 10KB程度で4G回線でも快適（約0.3秒）

2. **適度なスクロール量**
   - 疲れず、かつ十分な情報を提供

3. **データベース負荷の最小化**
   - クエリ実行時間が短い（約5ms）

4. **業界標準との整合性**
   - ユーザーが他サービスで慣れている挙動

### Demerit

1. **パワーユーザーには物足りない可能性**
   - 対策: `?limit=50` などでカスタマイズ可能に設計

2. **モバイルでは若干スクロールが多い**
   - 許容範囲内（約7回スクロール）

---

## Alternatives Considered

### Decision 1: レスポンス型

**代替案1: シンプル型（`total`, `page`, `limit` のみ）**
- 不採用理由: フロント側で計算ロジックが重複し、DRY原則に反する
- 不採用理由: 計算ミスのリスクが高く、保守性が低い

**代替案2: 最小限型（`data` のみ）**
- 不採用理由: ページ番号表示やボタン制御が不可能

### Decision 2: デフォルト件数

**代替案1: 10件**
- 不採用理由: ページ遷移が頻繁すぎてUX低下
- 不採用理由: レスポンスサイズ5KBは情報量として少なすぎ

**代替案2: 50件**
- 不採用理由: 初回ロードが重い（25KB）
- 不採用理由: スクロール疲れが発生

**代替案3: 無限スクロール**
- 不採用理由: 実装複雑度が高い
- 不採用理由: ブックマーク・共有が難しい
- 将来的な検討対象として保留

---

## Implementation Notes

### 柔軟性の確保

```typescript
// ユーザーがカスタマイズ可能
GET /api/consultations?limit=10  // 少なめ
GET /api/consultations?limit=50  // 多め

// 上限を設定してサーバー保護
const MAX_LIMIT = 100;
if (limit > MAX_LIMIT) {
  throw new ValidationError("limitは100以下を指定してください");
}
```

### 将来の拡張性

以下の機能追加を妨げない設計となっている：
- カーソルベースページネーション（無限スクロール対応）
- ユーザー設定による件数カスタマイズ
- モバイル専用の軽量レスポンス


## Summary

| 項目 | 決定内容 | 理由 |
|------|---------|------|
| **レスポンス型** | メタデータ充実型 | 保守性、実装速度、バグ予防の観点から最適 |
| **デフォルト件数** | 20件 | パフォーマンス、UX、業界標準の観点から最適 |
| **最大件数** | 100件 | サーバー負荷対策 |

**結論**: 保守性とユーザビリティを重視し、業界標準に準拠した設計を採用する。
