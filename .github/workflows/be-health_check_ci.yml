name: Backend CI / Cloudflare Credentials & Health Check

on:
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy_and_check:
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      WORKER_PATH: apps/fumufumu-backend # サブディレクトリのパスを定義

    defaults:
      run:
        working-directory: ${{ env.WORKER_PATH }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # jq のインストール (JSON操作のため)
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Enable pnpm via Corepack
        # Node.js がインストールされている環境で pnpm を有効化
        run: corepack enable
      
      - name: Install dependencies
        # pnpm-workspace.yamlがあるため pnpm install を実行し、依存関係を解決
        run: |
          pnpm install --frozen-lockfile

      # --- 【ステップ 1: シークレットの有効性確認】 ---

      - name: Validate Cloudflare API Token (wrangler whoami)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          workingDirectory: ${{ env.WORKER_PATH }}
          command: whoami # トークンが有効かをチェックするコマンド

      - name: Validate Account ID is Provided
        run: |
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "::error::CLOUDFLARE_ACCOUNT_ID is empty. Please check your GitHub Secrets."
            exit 1
          fi
          echo "Cloudflare Account ID is successfully loaded."

      # --- 【ステップ 2: プレビューデプロイ】 ---

      - name: Prepare wrangler.jsonc for CI Deploy
        # D1 バインディングエラー(10021)回避のため、設定ファイルから d1_databases を一時的に削除する
        run: |
          JQ_FILTER='del(.d1_databases)'
          # 変更を一時ファイルに保存し、元ファイルを上書き
          jq "$JQ_FILTER" wrangler.jsonc > wrangler.tmp.jsonc && mv wrangler.tmp.jsonc wrangler.jsonc
          echo "D1 database configuration removed from wrangler.jsonc for safe CI deployment."

      - name: Deploy to Cloudflare Preview
        id: worker-deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ${{ env.WORKER_PATH }}
          
          command: |
            deploy --env ci --name=${{ github.head_ref || github.ref_name }}-ci-test
            d1 binding set --env ci --name=DB --database-id=${{ secrets.D1_DATABASE_ID }}

      # --- 【ステップ 3: ヘルスチェックの実行】 ---

      - name: Wait and Validate D1 Connection via /health Endpoint
        run: |
          PREVIEW_URL="${{ steps.worker-deploy.outputs.deployment-url }}"
          
          echo "Waiting 5 seconds for Worker to propagate..."
          sleep 5

          echo "Checking health at: $PREVIEW_URL/health"
          
          # curlでリクエストを送信し、ステータスコードが200であることを確認
          curl -fS "$PREVIEW_URL/health"

          if [ $? -eq 0 ]; then
            echo "✅ Health check successful! D1 connection is confirmed."
          else
            echo "::error::Health check failed. Worker or D1 connection is down."
            exit 1
          fi