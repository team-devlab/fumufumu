name: Backend CI / Cloudflare Credentials & Health Check

on:
  pull_request:
    branches: [main, master]
  workflow_dispatch: # 手動実行の柔軟性を確保

jobs:
  deploy_and_check:
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      WORKER_PATH: apps/fumufumu-backend # サブディレクトリのパスを定義

    defaults:
      run:
        working-directory: ${{ env.WORKER_PATH }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Enable pnpm via Corepack
        # Node.js がインストールされている環境で pnpm を有効化
        run: corepack enable

      - name: Install dependencies
        # pnpm-workspace.yamlがあるため pnpm install を実行し、依存関係を解決
        run: pnpm install --frozen-lockfile

      # --- 【ステップ 1: シークレットの有効性確認】 ---

      - name: Validate Cloudflare API Token (wrangler whoami)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          # アクションに実行ディレクトリを明示
          workingDirectory: ${{ env.WORKER_PATH }}
          command: whoami

      - name: Validate Account ID is Provided
        run: |
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "::error::CLOUDFLARE_ACCOUNT_ID is empty. Please check your GitHub Secrets."
            exit 1
          fi
          echo "Cloudflare Account ID is successfully loaded."

      # --- 【ステップ 2: プレビューデプロイ】 ---

      - name: Deploy to Cloudflare Preview
        id: worker-deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # アクションに実行ディレクトリを明示
          workingDirectory: ${{ env.WORKER_PATH }}
          
          # commandオプションを使用し、プレビューとD1バインディングをCLI引数で渡す
          command: |
            deploy --preview --name=${{ github.head_ref || github.ref_name }}-ci-test
            d1 binding set --name=DB --database-id=${{ secrets.D1_DATABASE_ID }}

      # --- 【ステップ 3: ヘルスチェックの実行】 ---

      - name: Wait and Validate D1 Connection via /health Endpoint
        run: |
          PREVIEW_URL="${{ steps.worker-deploy.outputs.deployment-url }}"
          
          echo "Waiting 5 seconds for Worker to propagate..."
          sleep 5 # 安定化のための安全マージン

          echo "Checking health at: $PREVIEW_URL/health"
          
          # curlでリクエストを送信し、ステータスコードが200であることを確認
          # -fS: 4xx/5xx エラー時に CI が失敗するように強制
          curl -fS "$PREVIEW_URL/health"

          if [ $? -eq 0 ]; then
            echo "✅ Health check successful! D1 connection is confirmed."
          else
            echo "::error::Health check failed. Worker or D1 connection is down."
            exit 1
          fi