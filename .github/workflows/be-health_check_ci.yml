name: Backend CI / Cloudflare Credentials & Health Check

on:
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy_and_check:
    runs-on: ubuntu-latest

    # CIのシェルスクリプトで参照するために環境変数を設定
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      WORKER_PATH: apps/fumufumu-backend # サブディレクトリのパスを定義

    defaults:
      run:
        # run: コマンドは基本的に Worker のディレクトリで実行される
        working-directory: ${{ env.WORKER_PATH }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # jq のインストール (JSON操作のため)
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Node.js と pnpm のセットアップ
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Enable pnpm via Corepack
        run: corepack enable

      # 依存関係のインストール（Workerディレクトリ内で実行）
      - name: Install Worker Dependencies
        run: pnpm install --frozen-lockfile

      # --- 【ステップ 1: シークレットの有効性確認】 ---
      - name: Validate Cloudflare API Token (wrangler whoami)
        run: |
          npx wrangler whoami
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          
      - name: Validate Account ID is Provided
        run: |
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "::error::CLOUDFLARE_ACCOUNT_ID is empty. Please check your GitHub Secrets."
            exit 1
          fi
          echo "Cloudflare Account ID is successfully loaded."

      # --- 【ステップ 2: プレビューデプロイ】 ---

      - name: Prepare wrangler.jsonc for CI Deploy
        # D1 バインディングエラー(10021)回避のため、設定ファイルから d1_databases を一時的に削除する
        run: |
          JQ_FILTER='del(.d1_databases)'
          # 変更を一時ファイルに保存し、元ファイルを上書き
          jq "$JQ_FILTER" wrangler.jsonc > wrangler.tmp.jsonc && mv wrangler.tmp.jsonc wrangler.jsonc
          echo "D1 database configuration removed from wrangler.jsonc for safe CI deployment."

      - name: Deploy and Set D1 Binding
        id: worker-deploy
        run: |
          # 1. デプロイを実行し、結果を変数に格納（エラー時に出力を取得するため）
          DEPLOY_OUTPUT=$(npx wrangler deploy \
            --env ci \
            --name=${{ github.head_ref || github.ref_name }}-ci-test 2>&1)
            
          EXIT_CODE=$?

          # デバッグのため、Wranglerの出力全体を常にログに出力
          echo "--- Wrangler Output ---"
          echo "$DEPLOY_OUTPUT"
          echo "-----------------------"
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Worker Deployment Failed with exit code $EXIT_CODE. See Wrangler Output above for details."
            exit 1
          fi

          # 2. D1バインディングを設定（デプロイ成功後のみ）
          npx wrangler d1 binding set \
            --env ci \
            --name=DB \
            --database-id=${{ secrets.D1_DATABASE_ID }}
          
          if [ $? -ne 0 ]; then
            echo "::error::D1 Binding Setup Failed."
            exit 1
          fi

          # 3. プレビューURLの取得
          # 出力から 'https://' で始まり、かつ 'workers.dev' を含む行を抽出
          PREVIEW_URL=$(echo "$DEPLOY_OUTPUT" | grep 'https://' | grep 'workers.dev' | head -n 1)
          
          if [ -z "$PREVIEW_URL" ]; then
            echo "::error::Could not extract deployment URL from wrangler output. Check output for Malformed Response errors."
            exit 1
          fi

          # 後続のステップでURLを使えるようにする
          echo "deployment-url=$PREVIEW_URL" >> "$GITHUB_OUTPUT"
          echo "✅ Deployment successful. URL: $PREVIEW_URL"
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
      # --- 【ステップ 3: ヘルスチェックの実行】 ---

      - name: Wait and Validate D1 Connection via /health Endpoint
        run: |
          # worker-deployステップの出力を参照
          PREVIEW_URL="${{ steps.worker-deploy.outputs.deployment-url }}"
          
          echo "Waiting 5 seconds for Worker to propagate..."
          sleep 5

          echo "Checking health at: $PREVIEW_URL/health"
          
          # curlでリクエストを送信し、ステータスコードが200であることを確認 (-fSでエラー時に失敗)
          curl -fS "$PREVIEW_URL/health"

          if [ $? -eq 0 ]; then
            echo "✅ Health check successful! D1 connection is confirmed."
          else
            echo "::error::Health check failed. Worker or D1 connection is down."
            exit 1
          fi